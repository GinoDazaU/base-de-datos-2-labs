
ALTER TABLE employees ADD COLUMN salary int;
UPDATE employees e
SET salary = s.salary
FROM (
  SELECT DISTINCT ON (emp_no) emp_no, salary
  FROM salaries
  ORDER BY emp_no, to_date DESC
) s
WHERE e.emp_no = s.emp_no;


CREATE TABLE employees3 (
  emp_no int,
  birth_date date,
  first_name varchar(14),
  last_name varchar(16),
  gender character(1),
  hire_date date,
  dept_no varchar(5),
  from_date date,
  salary int
) PARTITION BY RANGE (date_part('year', hire_date), salary);


-- Años 1985–1990
CREATE TABLE emp_85_90_s1 PARTITION OF employees3 FOR VALUES FROM (1985, 0) TO (1985, 50000);
CREATE TABLE emp_85_90_s2 PARTITION OF employees3 FOR VALUES FROM (1985, 50000) TO (1985, 80000);
CREATE TABLE emp_85_90_s3 PARTITION OF employees3 FOR VALUES FROM (1985, 80000) TO (1990, 0);

-- Años 1990–1995
CREATE TABLE emp_90_95_s1 PARTITION OF employees3 FOR VALUES FROM (1990, 0) TO (1990, 50000);
CREATE TABLE emp_90_95_s2 PARTITION OF employees3 FOR VALUES FROM (1990, 50000) TO (1990, 80000);
CREATE TABLE emp_90_95_s3 PARTITION OF employees3 FOR VALUES FROM (1990, 80000) TO (1995, 0);

-- Años 1995–2000
CREATE TABLE emp_95_00_s1 PARTITION OF employees3 FOR VALUES FROM (1995, 0) TO (1995, 50000);
CREATE TABLE emp_95_00_s2 PARTITION OF employees3 FOR VALUES FROM (1995, 50000) TO (1995, 80000);
CREATE TABLE emp_95_00_s3 PARTITION OF employees3 FOR VALUES FROM (1995, 80000) TO (2000, 0);

-- Años 2000-2005
CREATE TABLE emp_00_05_s1 PARTITION OF employees3 FOR VALUES FROM (2000, 0) TO (2000, 50000);
CREATE TABLE emp_00_05_s2 PARTITION OF employees3 FOR VALUES FROM (2000, 50000) TO (2000, 80000);
CREATE TABLE emp_00_05_s3 PARTITION OF employees3 FOR VALUES FROM (2000, 80000) TO (2005, 0);

INSERT INTO employees3
SELECT * FROM employees;

-- Consulta 1
-- Empleados contratados en 1990 con salario mayor a 50,000
EXPLAIN ANALYZE
SELECT * FROM employees3
WHERE hire_date BETWEEN '1990-01-01' AND '1990-12-31'
  AND salary > 50000;

-- Consulta 2
-- Promedio salarial por año de contratación
EXPLAIN ANALYZE
SELECT date_part('year', hire_date) AS year, AVG(salary)
FROM employees3
GROUP BY year
ORDER BY year;

-- Consulta 3
-- Distribución salarial de los 90s
EXPLAIN ANALYZE
SELECT salary, COUNT(*)
FROM employees3
WHERE hire_date BETWEEN '1990-01-01' AND '1999-12-31'
GROUP BY salary
ORDER BY salary;


-- Fragmentacion anidada:

DROP TABLE IF EXISTS employees3 CASCADE;

CREATE TABLE employees3 (
  emp_no int,
  birth_date date,
  first_name varchar(14),
  last_name varchar(16),
  gender character(1),
  hire_date date,
  dept_no varchar(5),
  from_date date,
  salary int
) PARTITION BY RANGE (date_part('year', hire_date));

-- Año 1985
CREATE TABLE emp_1985 PARTITION OF employees3 FOR VALUES FROM (1985) TO (1986) PARTITION BY RANGE (salary);
CREATE TABLE emp_1985_s1 PARTITION OF emp_1985 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1985_s2 PARTITION OF emp_1985 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1985_s3 PARTITION OF emp_1985 FOR VALUES FROM (80000) TO (200000);

-- Año 1986
CREATE TABLE emp_1986 PARTITION OF employees3 FOR VALUES FROM (1986) TO (1987) PARTITION BY RANGE (salary);
CREATE TABLE emp_1986_s1 PARTITION OF emp_1986 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1986_s2 PARTITION OF emp_1986 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1986_s3 PARTITION OF emp_1986 FOR VALUES FROM (80000) TO (200000);

-- Año 1987
CREATE TABLE emp_1987 PARTITION OF employees3 FOR VALUES FROM (1987) TO (1988) PARTITION BY RANGE (salary);
CREATE TABLE emp_1987_s1 PARTITION OF emp_1987 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1987_s2 PARTITION OF emp_1987 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1987_s3 PARTITION OF emp_1987 FOR VALUES FROM (80000) TO (200000);

-- Año 1988
CREATE TABLE emp_1988 PARTITION OF employees3 FOR VALUES FROM (1988) TO (1989) PARTITION BY RANGE (salary);
CREATE TABLE emp_1988_s1 PARTITION OF emp_1988 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1988_s2 PARTITION OF emp_1988 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1988_s3 PARTITION OF emp_1988 FOR VALUES FROM (80000) TO (200000);

-- Año 1989
CREATE TABLE emp_1989 PARTITION OF employees3 FOR VALUES FROM (1989) TO (1990) PARTITION BY RANGE (salary);
CREATE TABLE emp_1989_s1 PARTITION OF emp_1989 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1989_s2 PARTITION OF emp_1989 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1989_s3 PARTITION OF emp_1989 FOR VALUES FROM (80000) TO (200000);

-- Año 1990
CREATE TABLE emp_1990 PARTITION OF employees3 FOR VALUES FROM (1990) TO (1991) PARTITION BY RANGE (salary);
CREATE TABLE emp_1990_s1 PARTITION OF emp_1990 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1990_s2 PARTITION OF emp_1990 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1990_s3 PARTITION OF emp_1990 FOR VALUES FROM (80000) TO (200000);

-- Año 1991
CREATE TABLE emp_1991 PARTITION OF employees3 FOR VALUES FROM (1991) TO (1992) PARTITION BY RANGE (salary);
CREATE TABLE emp_1991_s1 PARTITION OF emp_1991 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1991_s2 PARTITION OF emp_1991 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1991_s3 PARTITION OF emp_1991 FOR VALUES FROM (80000) TO (200000);

-- Año 1992
CREATE TABLE emp_1992 PARTITION OF employees3 FOR VALUES FROM (1992) TO (1993) PARTITION BY RANGE (salary);
CREATE TABLE emp_1992_s1 PARTITION OF emp_1992 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1992_s2 PARTITION OF emp_1992 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1992_s3 PARTITION OF emp_1992 FOR VALUES FROM (80000) TO (200000);

-- Año 1993
CREATE TABLE emp_1993 PARTITION OF employees3 FOR VALUES FROM (1993) TO (1994) PARTITION BY RANGE (salary);
CREATE TABLE emp_1993_s1 PARTITION OF emp_1993 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1993_s2 PARTITION OF emp_1993 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1993_s3 PARTITION OF emp_1993 FOR VALUES FROM (80000) TO (200000);

-- Año 1994
CREATE TABLE emp_1994 PARTITION OF employees3 FOR VALUES FROM (1994) TO (1995) PARTITION BY RANGE (salary);
CREATE TABLE emp_1994_s1 PARTITION OF emp_1994 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1994_s2 PARTITION OF emp_1994 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1994_s3 PARTITION OF emp_1994 FOR VALUES FROM (80000) TO (200000);

-- Año 1995
CREATE TABLE emp_1995 PARTITION OF employees3 FOR VALUES FROM (1995) TO (1996) PARTITION BY RANGE (salary);
CREATE TABLE emp_1995_s1 PARTITION OF emp_1995 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1995_s2 PARTITION OF emp_1995 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1995_s3 PARTITION OF emp_1995 FOR VALUES FROM (80000) TO (200000);

-- Año 1996
CREATE TABLE emp_1996 PARTITION OF employees3 FOR VALUES FROM (1996) TO (1997) PARTITION BY RANGE (salary);
CREATE TABLE emp_1996_s1 PARTITION OF emp_1996 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1996_s2 PARTITION OF emp_1996 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1996_s3 PARTITION OF emp_1996 FOR VALUES FROM (80000) TO (200000);

-- Año 1997
CREATE TABLE emp_1997 PARTITION OF employees3 FOR VALUES FROM (1997) TO (1998) PARTITION BY RANGE (salary);
CREATE TABLE emp_1997_s1 PARTITION OF emp_1997 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1997_s2 PARTITION OF emp_1997 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1997_s3 PARTITION OF emp_1997 FOR VALUES FROM (80000) TO (200000);

-- Año 1998
CREATE TABLE emp_1998 PARTITION OF employees3 FOR VALUES FROM (1998) TO (1999) PARTITION BY RANGE (salary);
CREATE TABLE emp_1998_s1 PARTITION OF emp_1998 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1998_s2 PARTITION OF emp_1998 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1998_s3 PARTITION OF emp_1998 FOR VALUES FROM (80000) TO (200000);

-- Año 1999
CREATE TABLE emp_1999 PARTITION OF employees3 FOR VALUES FROM (1999) TO (2000) PARTITION BY RANGE (salary);
CREATE TABLE emp_1999_s1 PARTITION OF emp_1999 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_1999_s2 PARTITION OF emp_1999 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_1999_s3 PARTITION OF emp_1999 FOR VALUES FROM (80000) TO (200000);

-- Año 2000
CREATE TABLE emp_2000 PARTITION OF employees3 FOR VALUES FROM (2000) TO (2001) PARTITION BY RANGE (salary);
CREATE TABLE emp_2000_s1 PARTITION OF emp_2000 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_2000_s2 PARTITION OF emp_2000 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_2000_s3 PARTITION OF emp_2000 FOR VALUES FROM (80000) TO (200000);

-- Año 2001
CREATE TABLE emp_2001 PARTITION OF employees3 FOR VALUES FROM (2001) TO (2002) PARTITION BY RANGE (salary);
CREATE TABLE emp_2001_s1 PARTITION OF emp_2001 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_2001_s2 PARTITION OF emp_2001 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_2001_s3 PARTITION OF emp_2001 FOR VALUES FROM (80000) TO (200000);

-- Año 2002
CREATE TABLE emp_2002 PARTITION OF employees3 FOR VALUES FROM (2002) TO (2003) PARTITION BY RANGE (salary);
CREATE TABLE emp_2002_s1 PARTITION OF emp_2002 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_2002_s2 PARTITION OF emp_2002 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_2002_s3 PARTITION OF emp_2002 FOR VALUES FROM (80000) TO (200000);

-- Año 2003
CREATE TABLE emp_2003 PARTITION OF employees3 FOR VALUES FROM (2003) TO (2004) PARTITION BY RANGE (salary);
CREATE TABLE emp_2003_s1 PARTITION OF emp_2003 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_2003_s2 PARTITION OF emp_2003 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_2003_s3 PARTITION OF emp_2003 FOR VALUES FROM (80000) TO (200000);

-- Año 2004
CREATE TABLE emp_2004 PARTITION OF employees3 FOR VALUES FROM (2004) TO (2005) PARTITION BY RANGE (salary);
CREATE TABLE emp_2004_s1 PARTITION OF emp_2004 FOR VALUES FROM (0) TO (50000);
CREATE TABLE emp_2004_s2 PARTITION OF emp_2004 FOR VALUES FROM (50000) TO (80000);
CREATE TABLE emp_2004_s3 PARTITION OF emp_2004 FOR VALUES FROM (80000) TO (200000);
